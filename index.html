<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TINTIN - Aprenda e Ensine</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      animation: slideUp 0.5s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    header {
      padding: 20px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
    }

    header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    header p {
      font-size: 12px;
      opacity: 0.9;
    }

    .container {
      padding: 24px 16px;
    }

    input,
    textarea,
    button {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s ease;
    }

    input:focus,
    textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
      box-shadow: none;
    }

    .card {
      border-radius: 15px;
      padding: 16px;
      border: 1px solid #f0f0f0;
      margin-bottom: 16px;
      background: #fafafa;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .card h4 {
      color: #333;
      margin-bottom: 8px;
      font-size: 18px;
    }

    .card p {
      color: #666;
      font-size: 13px;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .row button {
      flex: 1;
      min-width: 100px;
    }

    .chip {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      background: white;
      border: 1px solid #e0e0e0;
      font-size: 12px;
      color: #667eea;
      font-weight: 500;
      margin: 4px 4px 4px 0;
    }

    .small {
      font-size: 12px;
      color: #999;
    }

    .match-card {
      background: white;
      border: 1px solid #f0f0f0;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .match-card button {
      width: auto;
      padding: 8px 16px;
      font-size: 12px;
    }

    .messages {
      height: 250px;
      overflow-y: auto;
      border: 1px solid #f0f0f0;
      padding: 12px;
      border-radius: 10px;
      background: #fafafa;
      margin-bottom: 12px;
    }

    .message {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      background: white;
      border-left: 3px solid #667eea;
    }

    .message.own {
      border-left-color: #764ba2;
      text-align: right;
    }

    .message b {
      color: #667eea;
    }

    .message.own b {
      color: #764ba2;
    }

    .error {
      background: #ffe0e0;
      color: #c00;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .success {
      background: #e0ffe0;
      color: #0a0;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 13px;
    }

    .rating-stars {
      font-size: 24px;
      margin: 12px 0;
    }

    .star {
      cursor: pointer;
      color: #ddd;
      transition: color 0.2s;
    }

    .star:hover,
    .star.active {
      color: #ffc107;
    }

    .loading {
      text-align: center;
      padding: 40px 20px;
      color: #999;
    }

    .spinner {
      border: 3px solid #f0f0f0;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .badge {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>üíú TINTIN</h1>
      <p>Aprenda e Ensine com Pessoas Incr√≠veis</p>
    </header>
    <div class="container" id="root">
      <div class="loading">
        <div class="spinner"></div>
        <p>Carregando...</p>
      </div>
    </div>
  </div>

  <script>
    const API = '/api';
    let token = localStorage.getItem('tintin_token');
    let me = null;
    let socket = null;
    let currentMatchId = null;

    function setRoot(html) {
      document.getElementById('root').innerHTML = html;
    }

    async function api(path, opts = {}) {
      opts.headers = opts.headers || {};
      opts.headers['Content-Type'] = 'application/json';
      if (token) opts.headers['Authorization'] = 'Bearer ' + token;
      
      try {
        const res = await fetch(API + path, opts);
        const data = await res.json().catch(() => null);
        if (!res.ok) throw data || { error: 'Erro na requisi√ß√£o' };
        return data;
      } catch (error) {
        console.error(error);
        throw error;
      }
    }

    function connectSocket() {
      if (!token || !me) return;
      socket = io('', { auth: { token }, reconnection: true });
      
      socket.on('connect', () => console.log('‚úì Conectado'));
      socket.on('matched', (data) => {
        showNotification('üéâ Novo Match!');
        setTimeout(renderApp, 1500);
      });
      socket.on('message', (data) => {
        if (currentMatchId === data.matchId) {
          loadMessages(currentMatchId);
        }
      });
      socket.on('disconnect', () => console.log('‚úó Desconectado'));
    }

    function showNotification(msg) {
      alert(msg);
    }

    async function loadMe() {
      try {
        me = await api('/users/me');
        connectSocket();
      } catch (e) {
        me = null;
      }
    }

    function renderLogin() {
      setRoot(`
        <div class="card">
          <h4>Bem-vindo ao TINTIN</h4>
          <p class="small">Conecte-se e comece a aprender!</p>
          <input id="email" placeholder="Email" type="email" />
          <input id="password" placeholder="Senha" type="password" />
          <button onclick="login()">üîì Entrar</button>
          <button class="btn-secondary" onclick="register()">üìù Criar Conta</button>
          <p class="small" style="margin-top: 16px; text-align: center;">
            <strong>Demo:</strong> ana@example.com / password
          </p>
        </div>
      `);
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      if (!email || !password) {
        alert('Preencha todos os campos');
        return;
      }
      
      try {
        const res = await api('/auth/login', {
          method: 'POST',
          body: JSON.stringify({ email, password })
        });
        token = res.token;
        localStorage.setItem('tintin_token', token);
        await loadMe();
        renderApp();
      } catch (e) {
        alert('‚ùå Erro ao entrar: ' + (e.error || 'Verifique seus dados'));
      }
    }

    async function register() {
      const email = document.getElementById('email').value || 'user' + Math.floor(Math.random() * 1000) + '@example.com';
      const password = document.getElementById('password').value || 'password123';
      const name = email.split('@')[0];
      
      try {
        const res = await api('/auth/register', {
          method: 'POST',
          body: JSON.stringify({ name, email, password })
        });
        token = res.token;
        localStorage.setItem('tintin_token', token);
        await loadMe();
        renderApp();
      } catch (e) {
        alert('‚ùå Erro ao registrar: ' + (e.error || 'Tente novamente'));
      }
    }

    let cards = [];

    async function loadCards() {
      try {
        cards = await api('/swipe/cards');
      } catch (e) {
        cards = [];
      }
    }

    async function doSwipe(targetId, action) {
      try {
        const res = await api('/swipe/action', {
          method: 'POST',
          body: JSON.stringify({ targetUserId: targetId, action })
        });
        if (res.match) {
          showNotification('üéâ MATCH! Voc√™s combinam!');
        }
        await loadCards();
        renderSwipe();
      } catch (e) {
        alert('Erro ao fazer swipe');
      }
    }

    async function renderSwipe() {
      if (cards.length === 0) {
        setRoot(`
          <div class="card">
            <h4>üò¥ Sem cards dispon√≠veis</h4>
            <p class="small">Volte mais tarde para mais pessoas!</p>
            <button class="btn-secondary" onclick="renderApp()">‚Üê Voltar</button>
          </div>
        `);
        return;
      }

      const c = cards[0];
      const skillsHtml = (c.skills || []).map(s => `<span class="chip">${s.skill} (${s.mode})</span>`).join('');
      const ratingHtml = c.ratingAvg ? `<span class="badge">‚≠ê ${c.ratingAvg}</span>` : '';

      setRoot(`
        <div class="card">
          <h4>${c.name}${ratingHtml}</h4>
          <p class="small">${c.bio || 'Sem descri√ß√£o'}</p>
          <div style="margin: 12px 0;">${skillsHtml}</div>
          <div class="row">
            <button class="btn-secondary" onclick="skipCard()">üëé Passar</button>
            <button onclick="likeCard()">‚ù§Ô∏è Curtir</button>
          </div>
        </div>
        <button class="btn-secondary" onclick="renderApp()">‚Üê Menu</button>
      `);
      
      window.likeCard = () => doSwipe(c.id, 'like');
      window.skipCard = () => { cards = cards.filter(x => x.id !== c.id); renderSwipe(); };
    }

    async function renderMatches() {
      try {
        const ms = await api('/matches');
        
        const matchesHtml = ms.map(m => `
          <div class="match-card">
            <div><strong>${m.other}</strong></div>
            <button class="btn-secondary" onclick="openChat('${m.id}')">üí¨</button>
          </div>
        `).join('');

        setRoot(`
          <div class="card">
            <h4>üíú Meus Matches</h4>
            ${matchesHtml || '<p class="small">Nenhum match ainda :(</p>'}
            <button class="btn-secondary" style="margin-top: 12px;" onclick="renderApp()">‚Üê Voltar</button>
          </div>
        `);

        window.openChat = (matchId) => {
          currentMatchId = matchId;
          renderChat(matchId);
        };
      } catch (e) {
        alert('Erro ao carregar matches');
      }
    }

    async function loadMessages(matchId) {
      try {
        const msgs = await api('/matches/' + matchId + '/messages');
        const msgHtml = msgs.map(m => `
          <div class="message ${m.senderId === me.id ? 'own' : ''}">
            <b>${m.senderId === me.id ? 'Voc√™' : 'Outro'}:</b> ${m.content}
          </div>
        `).join('');
        
        const container = document.getElementById('msgs');
        if (container) {
          container.innerHTML = msgHtml;
          container.scrollTop = container.scrollHeight;
        }
      } catch (e) {
        console.error('Erro ao carregar mensagens', e);
      }
    }

    function sendMessage(matchId, text) {
      if (!socket || !text) return;
      socket.emit('send_message', { matchId, content: text });
      document.getElementById('msgtext').value = '';
      setTimeout(() => loadMessages(matchId), 100);
    }

    async function renderChat(matchId) {
      setRoot(`
        <div class="card">
          <h4>üí¨ Chat</h4>
          <div id="msgs" class="messages"></div>
          <input id="msgtext" placeholder="Digite uma mensagem..." />
          <div class="row">
            <button onclick="sendMsg()">Enviar</button>
            <button class="btn-secondary" onclick="renderMatches()">Voltar</button>
          </div>
        </div>
      `);

      window.sendMsg = () => {
        const text = document.getElementById('msgtext').value;
        sendMessage(matchId, text);
      };

      await loadMessages(matchId);
    }

    async function renderProfile() {
      setRoot(`
        <div class="card">
          <h4>üë§ Meu Perfil</h4>
          <input id="name" value="${me.name || ''}" placeholder="Nome" />
          <textarea id="bio" placeholder="Sobre voc√™" style="min-height: 80px;">${me.bio || ''}</textarea>
          <small class="small">Habilidades (formato: skill:teach, skill:learn)</small>
          <input id="skills" placeholder="Ex: Python:teach, Ingl√™s:learn" />
          <button onclick="saveProfile()">üíæ Salvar</button>
          <button class="btn-secondary" onclick="renderApp()">Voltar</button>
        </div>
      `);

      window.saveProfile = async () => {
        const name = document.getElementById('name').value;
        const bio = document.getElementById('bio').value;
        const skillsRaw = document.getElementById('skills').value;
        const skills = skillsRaw ? skillsRaw.split(',').map(s => {
          const [skill, mode] = s.split(':');
          return { skill: skill?.trim(), mode: mode?.trim() || 'learn' };
        }) : [];

        try {
          await api('/users/me', {
            method: 'PUT',
            body: JSON.stringify({ name, bio, skills })
          });
          await loadMe();
          alert('‚úì Perfil atualizado!');
          renderApp();
        } catch (e) {
          alert('Erro ao salvar');
        }
      };
    }

    function logout() {
      localStorage.removeItem('tintin_token');
      token = null;
      me = null;
      if (socket) socket.disconnect();
      renderLogin();
    }

    async function renderApp() {
      if (!token) {
        renderLogin();
        return;
      }

      await loadMe();
      await loadCards();

      setRoot(`
        <div class="card">
          <h4>üëã Ol√°, ${me.name}</h4>
          <p class="small">${me.bio || 'Configure seu perfil!'}</p>
          <div class="row">
            <button onclick="renderSwipe()">üî• Swipe</button>
            <button class="btn-secondary" onclick="renderMatches()">üíú Matches</button>
          </div>
          <div class="row">
            <button class="btn-secondary" onclick="renderProfile()">üë§ Perfil</button>
            <button class="btn-secondary" onclick="logout()">üö™ Sair</button>
          </div>
        </div>
      `);
    }

    // Init
    (async () => {
      if (token) await loadMe();
      renderApp();
    })();
  </script>
</body>
</html>